<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>‰∏ä‰º†ÂõæÁâá</title>
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="statics/css/upload.css">
</head>
<body>
<div id="app" class="container" v-cloak style="position: absolute; top:50%; left:50%; transform:translate(-50%,-50%);">
    <div class="uploading-data" v-if="isUploading"></div>

    <div class="upload-img-column">
        <div class="words">‰∏ä‰º†ÂõæÁâá ({{imgTempList.length}}/5)</div>
        <div class="upload-wrap">
            <div class="box">
                <label class="p dotted">
                    <input type="file" accept="image/jpg,image/jpeg,image/png" name="file"
                           @change="onChooseImage($event)"/>
                    <img src="./statics/images/jiahao.png" alt="">
                </label>
            </div>
            <template v-for="(imgItem, imgIndex) in imgTempList">
                <div class="box">
                    <div class="p">
                        <img :src="imgItem">
                        <div class="delete" @click.stop="deleteImg(imgIndex)">
                            <img src="./statics/images/guanbi.png" alt="">
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <button class="l-btn" @click="onUploadImg">‰∏ä‰º†</button>

    <!-- ÂõæÁâá‰∏ä‰º†ÊàêÂäüÂêéËøîÂõûÁöÑË∑ØÂæÑ(Ê≤°ÂøÖË¶ÅÁöÑ) -->
    <div class="success-path">
        <template v-for="(item, index) in successPath">
            <a :href="item" target="_blank">{{item}}</a>
        </template>
    </div>

    <!--  ÂéãÁº©ÂõæÁâáÁî®ÁöÑ  -->
    <canvas id="compressCanvas" style="position: fixed; z-index: -1; opacity: 0; top: -100%; left: -100%"></canvas>
</div>

<script src="statics/js/vue.min.js"></script>
<script>
    var app = new Vue({
        el: '#app',
        data: {
            username: "",
            imgTempList: [], //ÂõæÁâá‰∏¥Êó∂Ë∑ØÂæÑÂàóË°®
            isUploading: false, //ÊòØÂê¶Ê≠£Âú®‰∏ä‰º†
            successPath: [], //‰∏ä‰º†ÊàêÂäüÂêéÁöÑË∑ØÂæÑ(Ê≤°ÂøÖË¶Å)
        },
        mounted: function (){
            localStorage.setItem("username", "logan");
            if(localStorage.username){
                this.username=localStorage.username;
            }
            else{
                window.location.href="./loginform.html";
            }
        },
        watch: {},
        methods: {
            //ÈÄâÊã©ÂõæÁâá
            onChooseImage: function (event) {
                var that = this;

                //Âà§Êñ≠ÂõæÁâáÊï∞ÈáèÊòØÂê¶Â∑≤‰∏äÈôê
                var currentImgTempArray = that.imgTempList;
                if (currentImgTempArray.length >= 5) {
                    alert("ÊúÄÂ§ö‰∏ä‰º†5Âº†ÂõæÁâá");
                    return false;
                }

                //‰ΩøÁî®FileReaderÂØπÊñá‰ª∂ÂØπË±°ËøõË°åÊìç‰Ωú
                var reader = new FileReader();
                reader.readAsDataURL(event.target.files[0]); //Â∞ÜËØªÂèñÂà∞ÁöÑÊñá‰ª∂ÁºñÁ†ÅÊàêData URL
                reader.onload = function () { //ËØªÂèñÂÆåÊàêÊó∂
                    var replaceSrc = reader.result; //Êñá‰ª∂ËæìÂá∫ÁöÑÂÜÖÂÆπ

                    //ÂéãÁº©ÂõæÁâáÂ§ÑÁêÜ
                    var image = new Image();
                    image.src = replaceSrc;
                    image.onload = function () {
                        //Ëé∑ÂèñÂõæÁâáÂàùÂßãÂÆΩÈ´ò
                        var width = image.width;
                        var height = image.height;
                        //Âà§Êñ≠ÂõæÁâáÂÆΩÂ∫¶ÔºåÂÜçÊåâÊØî‰æãËÆæÁΩÆÂÆΩÂ∫¶ÂíåÈ´òÂ∫¶ÁöÑÂÄº
                        if (width > 1024) {
                            width = 1024;
                            height = Math.ceil(1024 * (image.height / image.width));
                        }

                        //Â∞ÜÂõæÁâáÈáçÊñ∞ÁîªÂÖ•canvas‰∏≠
                        var canvas = document.getElementById("compressCanvas");
                        var context = canvas.getContext("2d");
                        canvas.width = width;
                        canvas.height = height;
                        context.beginPath();
                        context.fillStyle = "#ffffff";
                        context.fillRect(0, 0, width, height);
                        context.fill();
                        context.closePath();
                        context.drawImage(image, 0, 0, width, height);
                        replaceSrc = canvas.toDataURL("image/jpeg"); //canvasËΩ¨DataURL(base64Ê†ºÂºè)

                        //Â∞ÜÂéãÁº©ÂêéÁöÑË∑ØÂæÑ ËøΩÂä†Âà∞‰∏¥Êó∂Ë∑ØÂæÑÊï∞ÁªÑ‰∏≠
                        var totalList = [];
                        if (currentImgTempArray.length > 0) {
                            totalList = currentImgTempArray.concat(replaceSrc);
                        } else {
                            totalList[0] = replaceSrc;
                        }
                        that.imgTempList = totalList;
                    };
                };

            },

            //Âà†Èô§ÊüêÂº†ÂõæÁâá
            deleteImg: function (idx) {
                var that = this;
                that.imgTempList.splice(idx, 1);
            },

            //Êèê‰∫§‰∏ä‰º†ÂõæÁâá
            onUploadImg: function () {
                var that = this;
                var imgTempList = that.imgTempList;
                if (imgTempList.length > 0) {

                    that.isUploading = true; //Ê≠£Âú®‰∏ä‰º† ÊòæÁ§∫ÈÅÆÁΩ©Â±Ç Èò≤Ê≠¢ËøûÁª≠ÁÇπÂáª

                    var countNum = 0; //ËÆ°ÁÆóÊï∞ÈáèÁî®ÁöÑ Âà§Êñ≠‰∏ä‰º†Âà∞Á¨¨Âá†Âº†ÂõæÁâá‰∫Ü

                    //mapÂæ™ÁéØÈÅçÂéÜ‰∏ä‰º†ÂõæÁâá
                    imgTempList.map(function (imgItem, imgIndex) {
                        var files = that.dataURLtoFile(imgItem, 'pj' + Date.now() + '.jpg'); //DataURLËΩ¨File

                        //ÂàõFormDataÂØπË±°
                        var formdata = new FormData();
                        //append(key,value)Âú®Êï∞ÊçÆÊú´Â∞æËøΩÂä†Êï∞ÊçÆ„ÄÇ ËøôÂÑøÁöÑkeyÂÄºÈúÄË¶ÅÂíåÂêéÂè∞ÂÆö‰πâ‰øùÊåÅ‰∏ÄËá¥
                        formdata.append(that.username, files);

                        //Áî®axios‰∏ä‰º†Ôºå
                        axios({
                            method: "POST",
                            //url: "http://www.clluo.com:8060/uploadImg",
							url: "http://47.107.227.208:8002/upload",
                            data: formdata,
                            headers: {
                                "Content-Type": "multipart/form-data"
                            }
                        }).then(function (res) {
                            console.log(res);
                            countNum++;
                            console.log("Á¨¨ " + countNum + " Âº†ÂõæÁâá‰∏ä‰º†ÂÆåÊàê");
                            //ÂõæÁâáÂÖ®ÈÉ®‰∏ä‰º†ÂÆåÂêéÂéªÊéâÈÅÆÁΩ©Â±Ç
                            if (countNum >= imgTempList.length) {
                                that.isUploading = false;
                            }

                            //Ê≤°ÂøÖË¶ÅÁöÑ‰ª£Á†Å üëá
                            var list = [];
                            if (that.successPath.length > 0) {
                                list = that.successPath.concat(res.data.path);
                            } else {
                                list[0] = res.data.path;
                            }
                            that.successPath = list;

                        }).catch(function (error) {
                            console.error(error);
                        });
                    });
                }
            },

            /**
             * Â∞Übase64ËΩ¨Êç¢‰∏∫Êñá‰ª∂
             * @dataUrl base64Ë∑ØÂæÑÂú∞ÂùÄ
             * @fileName Ëá™ÂÆö‰πâÊñá‰ª∂ÂêçÂ≠ó
             * */
            dataURLtoFile: function (dataUrl, fileName) {
                var arr = dataUrl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                    bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                return new File([u8arr], fileName, {type: mime});
            },
        }
    });
</script>
</body>
</html>